<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>03 Kubernetes 应用程序生命周期管理(Yaml、Pod、Service、Scale、Autoscale、HPA、Rollout) | dreamLinux博客</title>
    <meta property="og:title" content="03 Kubernetes 应用程序生命周期管理(Yaml、Pod、Service、Scale、Autoscale、HPA、Rollout) - dreamLinux博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2021-01-09T11:00:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2021-01-09T11:00:00&#43;08:00'>
        
    <meta name="Keywords" content="linux,python,go语言笔记,博客,项目管理,python,软件架构">
    <meta name="description" content="03 Kubernetes 应用程序生命周期管理(Yaml、Pod、Service、Scale、Autoscale、HPA、Rollout)">
        
    <meta name="author" content="IT干饭人">
    <meta property="og:url" content="https://hardy1970.github.io/post/03-kubernetes-life-cycle/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
        <link rel="stylesheet" href='/css/douban.css'>
    
        <link rel="stylesheet" href='/css/other.css'>
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://hardy1970.github.io">
                        dreamLinux博客
                    </a>
                
                <p class="description">专注于Linux、Python、Go、Docker、ELKStack 等开源技术交流分享</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://hardy1970.github.io">首页</a>
                    
                    <a  href="https://hardy1970.github.io/tools/" title="工具">工具</a>
                    
                    <a  href="https://hardy1970.github.io/archives/" title="归档">归档</a>
                    
                    <a  href="https://hardy1970.github.io/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 200px;
        margin-left: -210px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 20px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
        display: none;
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#在kubernetes中部署应用流程">在kubernetes中部署应用流程</a>
      <ul>
        <li><a href="#01-制作镜像包括三种镜像">01 制作镜像(包括三种镜像)</a></li>
        <li><a href="#02-使用控制器部署镜像">02 使用控制器部署镜像</a></li>
        <li><a href="#03-对外暴露应用">03 对外暴露应用</a></li>
      </ul>
    </li>
    <li><a href="#服务编排yaml">服务编排（yaml）</a>
      <ul>
        <li><a href="#yaml">yaml</a></li>
      </ul>
    </li>
    <li><a href="#应用升级弹性伸缩回滚删除">应用升级、弹性伸缩、回滚、删除</a>
      <ul>
        <li></li>
        <li><a href="#弹性伸缩">弹性伸缩</a></li>
        <li><a href="#回滚">回滚</a></li>
        <li><a href="#滚动更新策略">滚动更新策略</a></li>
        <li><a href="#pod对象">pod对象</a></li>
      </ul>
    </li>
  </ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if(leftPos<220){
                postToc.css({"width":leftPos-10,"margin-left":(0-leftPos)})
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }
    })
</script>
    <article class="post">
        <header>
            <h1 class="post-title">03 Kubernetes 应用程序生命周期管理(Yaml、Pod、Service、Scale、Autoscale、HPA、Rollout)</h1>
        </header>
        <date class="post-meta meta-date">
            2021年1月9日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='/categories/Kubernetes'>Kubernetes</a></span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="clear" style="display: none">
            <div class="toc-article">
                <div class="toc-title">文章目录</div>
            </div>
        </div>
        
        <div class="post-content">
            <h2 id="在kubernetes中部署应用流程">在kubernetes中部署应用流程</h2>
<p>制作镜像（Dockerfile）&mdash;- 使用控制器部署镜像（Deployment、StatefulSet、DaemonSet）&mdash;- 对外暴露应用（Service、Ingress）&mdash;- 日志、监控&mdash;- 日常运维</p>
<h3 id="01-制作镜像包括三种镜像">01 制作镜像(包括三种镜像)</h3>
<ul>
<li>基础镜像</li>
<li>运行环境镜像</li>
<li>项目镜像</li>
</ul>
<h3 id="02-使用控制器部署镜像">02 使用控制器部署镜像</h3>
<ul>
<li>controllers(控制器)作用
<ul>
<li>管理pod对象</li>
<li>使用标签与pod关联</li>
<li>控制器实现了pod运维，例如滚动更新、伸缩、副本管理、维护pod状态等</li>
</ul>
</li>
<li>Deployment是最为常用的controlls (也成为workload)，其它控制器还有Daemonset、Statefulset等。
<ul>
<li>Statefulset 有状态的服务</li>
<li>DaemonSet,会在每个节点启动一个pod,监控类，mysql集群，略</li>
<li>Deployment，应用场景：部署网站、api、微服务等
<ul>
<li>功能如下
<ul>
<li>管理pod和replicaSet</li>
<li>具有上线部署、副本设定、滚动升级、回滚等功能</li>
<li>提供声明式更新，例如只更新一个新的image</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="03-对外暴露应用">03 对外暴露应用</h3>
<ul>
<li>Service
<pre><code>[root@node01 ~]# kubectl expose deployment/nginx-deployment --port=80 --type=NodePort --name=web
</code></pre></li>
<li>Ingress</li>
</ul>
<h2 id="服务编排yaml">服务编排（yaml）</h2>
<table>
<thead>
<tr>
<th>角色</th>
<th>IP</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>apiVersion</td>
<td>API版本</td>
<td>kubectl api-versions可以获取支持的接口api</td>
</tr>
<tr>
<td>kind</td>
<td>资源类型</td>
<td></td>
</tr>
<tr>
<td>k8s-node2</td>
<td>资源元数据</td>
<td></td>
</tr>
<tr>
<td>spec</td>
<td>资源规格</td>
<td></td>
</tr>
<tr>
<td>replicas</td>
<td>副本数量</td>
<td></td>
</tr>
<tr>
<td>selector</td>
<td>标签选择器</td>
<td></td>
</tr>
<tr>
<td>template</td>
<td>pod模板</td>
<td></td>
</tr>
<tr>
<td>metadata</td>
<td>pod元数据</td>
<td></td>
</tr>
<tr>
<td></td>
<td>pod规格</td>
<td></td>
</tr>
<tr>
<td>containers</td>
<td>容器配置</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="yaml">yaml</h3>
<ul>
<li>语法格式：
<ul>
<li>缩进标识层级管理</li>
<li>不支持制表符“tab”缩进，使用空格缩进</li>
<li>通常开头缩进2个空格</li>
<li>字符后缩进一个空格，如冒号、逗号等</li>
<li>“&mdash;”表示YAML格式，一个文件的开始</li>
<li>“#” 注释</li>
</ul>
</li>
<li>标签在资源关联的用法：
<ul>
<li>标签选择器 selector，通过一组标签查询相关的资源</li>
<li>标签 labels</li>
</ul>
</li>
<li>deployment示例：https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/</li>
<li>service示例：https://kubernetes.io/zh/docs/concepts/services-networking/service/</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#998;font-style:italic"># cat deployment.yaml</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#998;font-style:italic"># 控制器定义</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000080">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb"> </span><span style="color:#998;font-style:italic"># api版本</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000080">kind</span>:<span style="color:#bbb"> </span>Deployment    <span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#资源类型  </span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000080">metadata</span>:<span style="color:#bbb">  </span><span style="color:#998;font-style:italic">#资源元数据</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>nginx-deployment<span style="color:#bbb"> </span><span style="color:#998;font-style:italic"># 同一个命名空间下不能重复</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">namespace</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb"> </span><span style="color:#998;font-style:italic"># 不写默认就是 default</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">labels</span>:<span style="color:#bbb"> 
</span><span style="color:#bbb">    </span><span style="color:#000080">app</span>:<span style="color:#bbb"> </span>nginx <span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000080">spec</span>:<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#资源规格</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">replicas</span>:<span style="color:#bbb"> </span><span style="color:#099">3</span><span style="color:#bbb"> </span><span style="color:#998;font-style:italic"># 副本数量</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">selector</span>:<span style="color:#bbb"> </span><span style="color:#998;font-style:italic"># 标签选择器</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">matchLabels</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#000080">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#998;font-style:italic"># 被控制对象</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">template</span>:<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#pod模板</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">metadata</span>:<span style="color:#bbb"> </span><span style="color:#998;font-style:italic"># pod元数据</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#000080">labels</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000080">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">spec</span>:<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#pod规格</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#000080">containers</span>:<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#容器配置</span><span style="color:#bbb">
</span><span style="color:#bbb">      </span>- <span style="color:#000080">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000080">image</span>:<span style="color:#bbb"> </span>nginx:1.14.2<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000080">ports</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span>- <span style="color:#000080">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#099">80</span><span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#998;font-style:italic"># cat service.yaml</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">kind</span>:<span style="color:#bbb"> </span>Service<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>my-service<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">selector</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#000080">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">#与pod关联</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">ports</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>- <span style="color:#000080">protocol</span>:<span style="color:#bbb"> </span>TCP<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000080">port</span>:<span style="color:#bbb"> </span><span style="color:#099">80</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000080">targetPort</span>:<span style="color:#bbb"> </span><span style="color:#099">80</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">type</span>:<span style="color:#bbb"> </span>NodePort <span style="color:#bbb">
</span><span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><ul>
<li>
<p>资源字段太多，记不住怎么办</p>
</li>
<li>
<p>用create命令生成</p>
<pre><code>[root@node01 ~]# kubectl create deployment web --image=nginx --dry-run=client -o yaml 
</code></pre></li>
<li>
<p>用get命令导出，删掉不常用和F开头的</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get  my-deploy/nginx -o=yaml --export &gt; my-deploy.yaml # 用get命令导出，删掉不常用和f开头的</span>
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>pod容器的字段拼写忘记了</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl explain pods.spec.containers</span>
<span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl explain deployment</span>
</code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h2 id="应用升级弹性伸缩回滚删除">应用升级、弹性伸缩、回滚、删除</h2>
<h4 id="升级">升级</h4>
<pre><code>kubectl set image (-f FILENAME | TYPE NAME) CONTAINER_NAME_1=CONTAINER_IMAGE_1 ... CONTAINER_NAME_N=CONTAINER_IMAGE_N
</code></pre><ul>
<li>针对某个容器镜像升级</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl set image deployment/nginx-deployment nginx=nginx:1.16 --record #指定容器名字镜像升级，--record 将当前命令计入到发布记录中</span>
deployment.apps/nginx-deployment image updated
<span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl rollout status deployment/nginx-deployment #查看升级状态</span>
Waiting <span style="color:#000;font-weight:bold">for</span> deployment <span style="color:#d14">&#34;nginx-deployment&#34;</span> rollout to finish: <span style="color:#099">1</span> out of <span style="color:#099">3</span> new replicas have been updated...
Waiting <span style="color:#000;font-weight:bold">for</span> deployment <span style="color:#d14">&#34;nginx-deployment&#34;</span> rollout to finish: <span style="color:#099">1</span> out of <span style="color:#099">3</span> new replicas have been updated...
Waiting <span style="color:#000;font-weight:bold">for</span> deployment <span style="color:#d14">&#34;nginx-deployment&#34;</span> rollout to finish: <span style="color:#099">1</span> out of <span style="color:#099">3</span> new replicas have been updated...
Waiting <span style="color:#000;font-weight:bold">for</span> deployment <span style="color:#d14">&#34;nginx-deployment&#34;</span> rollout to finish: <span style="color:#099">2</span> out of <span style="color:#099">3</span> new replicas have been updated...
Waiting <span style="color:#000;font-weight:bold">for</span> deployment <span style="color:#d14">&#34;nginx-deployment&#34;</span> rollout to finish: <span style="color:#099">2</span> out of <span style="color:#099">3</span> new replicas have been updated...
Waiting <span style="color:#000;font-weight:bold">for</span> deployment <span style="color:#d14">&#34;nginx-deployment&#34;</span> rollout to finish: <span style="color:#099">2</span> out of <span style="color:#099">3</span> new replicas have been updated...
Waiting <span style="color:#000;font-weight:bold">for</span> deployment <span style="color:#d14">&#34;nginx-deployment&#34;</span> rollout to finish: <span style="color:#099">1</span> old replicas are pending termination...
Waiting <span style="color:#000;font-weight:bold">for</span> deployment <span style="color:#d14">&#34;nginx-deployment&#34;</span> rollout to finish: <span style="color:#099">1</span> old replicas are pending termination...
deployment <span style="color:#d14">&#34;nginx-deployment&#34;</span> successfully rolled out
<span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># curl http://192.168.241.121:32175/version</span>
&lt;html&gt;
&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx/1.16.1&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
<span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># </span>
<span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl set image deployment/nginx-deployment nginx=nginx:1.16 --record</span>
Error from server <span style="color:#000;font-weight:bold">(</span>NotFound<span style="color:#000;font-weight:bold">)</span>: deployments.apps <span style="color:#d14">&#34;nginx-deployment&#34;</span> not found
<span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl set image deployment/web nginx=nginx:1.16 --record</span>
deployment.apps/web image updated
<span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get rs</span>
NAME             DESIRED   CURRENT   READY   AGE
web-567b5ddc48   <span style="color:#099">0</span>         <span style="color:#099">0</span>         <span style="color:#099">0</span>       31m
web-6cf58ffc64   <span style="color:#099">0</span>         <span style="color:#099">0</span>         <span style="color:#099">0</span>       96m
web-744784fd55   <span style="color:#099">0</span>         <span style="color:#099">0</span>         <span style="color:#099">0</span>       35m
web-755ccc95f4   <span style="color:#099">3</span>         <span style="color:#099">3</span>         <span style="color:#099">3</span>       14s
<span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl rollout history deployment/web</span>
deployment.apps/web 
REVISION  CHANGE-CAUSE
<span style="color:#099">5</span>         &lt;none&gt;
<span style="color:#099">6</span>         &lt;none&gt;
<span style="color:#099">7</span>         &lt;none&gt;
<span style="color:#099">8</span>         kubectl <span style="color:#0086b3">set</span> image deployment/web <span style="color:#008080">nginx</span><span style="color:#000;font-weight:bold">=</span>nginx:1.16 --record<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span>

<span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># curl http://192.168.241.121:31162/version</span>
&lt;html&gt;
&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx/1.16.1&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
<span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># </span>
</code></pre></td></tr></table>
</div>
</div><h3 id="弹性伸缩">弹性伸缩</h3>
<ul>
<li>
<p>手动扩容</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl scale deployment nginx-deployment --replicas=10 #设置副本</span>
deployment.apps/nginx-deployment scaled
<span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get deploy</span>
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
aliang-666         1/1     <span style="color:#099">1</span>            <span style="color:#099">1</span>           8h
nginx-deployment   10/10   <span style="color:#099">10</span>           <span style="color:#099">10</span>          63m
web                1/1     <span style="color:#099">1</span>            <span style="color:#099">1</span>           44m
</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>HPA：pod水平扩容</p>
<ul>
<li>
<p>流程： hpa&ndash;&gt; apiserver &ndash;&gt; metrics-server &ndash;&gt; kubelet &ndash;&gt; pod（资源利用率）</p>
</li>
<li>
<p>新增 hpa 水平扩容 <a href="https://kubernetes.io/zh/docs/tasks/run-application/horizontal-pod-autoscale/">参照官网</a></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl autoscale deployment nginx-deployment --min=3 --max=10 --cpu-percent=10</span>
horizontalpodautoscaler.autoscaling/nginx-deployment autoscaled
<span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get hpa</span>
NAME               REFERENCE                     TARGETS         MINPODS   MAXPODS   REPLICAS   AGE
nginx-deployment   Deployment/nginx-deployment   &lt;unknown&gt;/10%   <span style="color:#099">3</span>         <span style="color:#099">10</span>        <span style="color:#099">10</span>         38s
<span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># </span>
<span style="color:#998;font-style:italic"># 配置resources后再次查看</span>
<span style="color:#000;font-weight:bold">[</span>root@node01 demo<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get hpa</span>
NAME               REFERENCE                     TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
nginx-deployment   Deployment/nginx-deployment   0%/10%    <span style="color:#099">3</span>         <span style="color:#099">10</span>        <span style="color:#099">3</span>          6m31s
<span style="color:#000;font-weight:bold">[</span>root@node01 demo<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># </span>

</code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>kubelet必须配置resources,否则状态一直unknown</p>
</li>
<li>
<p>如果出现unknown</p>
<ul>
<li>kubelet top pod #是否正常</li>
<li>deployment 里面是否配置requests</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#998;font-style:italic">#示例</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000080">apiVersion</span>:<span style="color:#bbb"> </span>apps/v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000080">kind</span>:<span style="color:#bbb"> </span>Deployment<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000080">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>web<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">labels</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000080">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">replicas</span>:<span style="color:#bbb"> </span><span style="color:#099">3</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">selector</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">matchLabels</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#000080">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">template</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#000080">labels</span>:<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000080">app</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#000080">containers</span>:<span style="color:#bbb">
</span><span style="color:#bbb">      </span>- <span style="color:#000080">image</span>:<span style="color:#bbb"> </span>nginx:1.14.2<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000080">imagePullPolicy</span>:<span style="color:#bbb"> </span>IfNotPresent<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000080">resources</span>:<span style="color:#bbb">
</span><span style="color:#bbb">          </span><span style="color:#000080">requests</span>:<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#000080">cpu</span>:<span style="color:#bbb"> </span><span style="color:#099">0.5</span><span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p>压测</p>
<pre><code>[root@node03 ~]# ab -n 100000 -c 100 -H &quot;User-Agent: Mozilla/5.0 (iPhone; CPU iPhone OS 12_1_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/16D57 unknown BingWeb/6.9.8.1&quot; &quot;http://192.168.241.121:32175/&quot;
This is ApacheBench, Version 2.3 &lt;$Revision: 1430300 $&gt;
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/
    
Benchmarking 192.168.241.121 (be patient)
Completed 10000 requests
Completed 20000 requests
Completed 30000 requests
Completed 40000 requests
Completed 50000 requests
Completed 60000 requests
Completed 70000 requests
Completed 80000 requests
Completed 90000 requests
apr_pollset_poll: The timeout specified has expired (70007)
Total of 98829 requests completed

</code></pre></li>
<li>
<p>查看hpa，以及副本状况</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#000;font-weight:bold">[</span>root@node01 demo<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get hpa</span>
NAME               REFERENCE                     TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
nginx-deployment   Deployment/nginx-deployment   31%/10%   <span style="color:#099">3</span>         <span style="color:#099">10</span>        <span style="color:#099">10</span>         12m

<span style="color:#000;font-weight:bold">[</span>root@node01 demo<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl get deploy</span>
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
aliang-666         1/1     <span style="color:#099">1</span>            <span style="color:#099">1</span>           9h
nginx-deployment   6/10    <span style="color:#099">10</span>           <span style="color:#099">6</span>           88m
web                1/1     <span style="color:#099">1</span>            <span style="color:#099">1</span>           69m

</code></pre></td></tr></table>
</div>
</div></li>
</ul>
</li>
</ul>
<h3 id="回滚">回滚</h3>
<p><a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/">参照官网</a></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#000;font-weight:bold">[</span>root@node01 demo<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl rollout history deployment/nginx-deployment</span>
<span style="color:#000;font-weight:bold">[</span>root@node01 demo<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl rollout undo deployment/nginx-deployment                 # 回滚上一个版本</span>
<span style="color:#000;font-weight:bold">[</span>root@node01 demo<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl rollout undo deployment/nginx-deployment --to-revision=2 # 回滚指定版本</span>
<span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># curl http://192.168.241.121:32175/version</span>
&lt;html&gt;
&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx/1.18.0&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
<span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># kubectl rollout undo deployment/nginx-deployment  --to-revision=4</span>
deployment.apps/web rolled back
<span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># curl http://192.168.241.121:32175/version</span>
&lt;html&gt;
&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx/1.16/center&gt;
&lt;/body&gt;
&lt;/html&gt;
<span style="color:#000;font-weight:bold">[</span>root@node01 ~<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic"># </span>
</code></pre></td></tr></table>
</div>
</div><h3 id="滚动更新策略">滚动更新策略</h3>
<p>每次只升级一个或多个服务，升级完成后加入生产环境，不断执行这个过程，直到集群中的全部旧版本升级新版本。<br>
特点：用户无感知，平滑过渡<br>
缺点：部署周期长、发布策略较复杂</p>
<p>滚动更新在k8s中实现：控制器死循环在里面</p>
<ul>
<li>1个deployment</li>
<li>2个ReplicaSet 副本集
<ul>
<li>协助deployment做事</li>
<li>pod副本数量管理，不断对比当前pod数量与期望pod数量</li>
<li>deployment每次发布都会创建一个RS 作为记录，用于实现回滚</li>
<li>kubectl get rs #查看RS记录</li>
<li>kubectl rollout history deployment nginx-deployment # 版本对应RS记录</li>
</ul>
</li>
</ul>
<h3 id="pod对象">pod对象</h3>
<h4 id="pod概念">pod概念</h4>
<ul>
<li>最小的部署单元</li>
<li>一组容器的集合</li>
<li>一个pod中的容器共享网络命名空间</li>
<li>pod是短暂的</li>
<li>pod定义</li>
</ul>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#bbb">  </span><span style="color:#000080">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>my-pod<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">containers</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- <span style="color:#000080">image</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>container2<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">containers</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- <span style="color:#000080">image</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>container2<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="pod设计思想">pod设计思想</h4>
<ul>
<li>pod为亲密性应用而存在<br>
亲密性应用场景：
<ul>
<li>两个应用之间发生文件交互
<ul>
<li>两个应用通过NFS 或者两个应用部署在同一个宿主机，通过数据卷的形式</li>
</ul>
</li>
<li>两个应用需要通过127.0.0.1或者socket通信（典型组合：nginx+php）</li>
<li>两个应用需要发生频繁的调用</li>
</ul>
</li>
<li>pod对象：容器分类
<ul>
<li>Infrastructure Container: 基础容器，维护整个pod网络空间</li>
<li>InitContainers：初始化容器，先于容器开始执行</li>
<li>Containers：业务容器，并行启动</li>
</ul>
</li>
</ul>
<h4 id="应用自修复">应用自修复</h4>
<ul>
<li>重启策略
<ul>
<li>Always：当容器终止退出后，总是重启容器，默认策略，持久运行的程序，例如nginx</li>
<li>onFailure：当容器异常退出（退出状态码非0）时，才重启容器。计划任务 cronjob。</li>
<li>Never:  当容器终止退出，永不重启容器。数据处理的程序job。</li>
</ul>
</li>
<li>健康检查
<ul>
<li>分两种类型
<ul>
<li>livenessProbe(存活检查)：如果检查失败，将杀死容器，根据Pod的restartPolicy来操作。</li>
<li>readlinessProbe(就绪检查)：如果检查失败，Kubernetes会把Pod从service endpoints中剔除。</li>
</ul>
</li>
<li>支持以下三种检查方法：
<ul>
<li>httpGet：发送HTTP请求，返回200-400范围状态码为成功</li>
<li>exec:  执行shell命令返回状态码是0为成功。</li>
<li>tcpSocket: 发起TCP Socket建立成功。</li>
</ul>
</li>
<li>日常运维检查方法：
<ul>
<li>tcp 端口探测</li>
<li>curl http://ip/status.html</li>
<li>ping 检查服务器状态</li>
<li>端口监听</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="init-container">Init container</h4>
<ul>
<li>基本支持所有普通容器特征</li>
<li>优先普通容器执行</li>
<li>应用场景
<ul>
<li>控制普通容器启动，初始化容器完成后才会启动业务容器</li>
<li>初始化配置，例如下载应用高配置文件、注册信息等</li>
</ul>
</li>
<li>案例：
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#998;font-style:italic"># 下载http://www.baidu.com/index.html 到数据卷并挂载到nginx容器</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000080">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000080">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000080">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>init-demo<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000080">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">containers</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#000080">name</span>:<span style="color:#bbb"> </span>my-nginx<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">image</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">ports</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- <span style="color:#000080">containerPort</span>:<span style="color:#bbb"> </span><span style="color:#099">80</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">volumeMounts</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- <span style="color:#000080">name</span>:<span style="color:#bbb"> </span>workdir<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#000080">mountPath</span>:<span style="color:#bbb"> </span><span style="color:#d14">&#34;/usr/share/nginx/html&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">initContainers</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#000080">name</span>:<span style="color:#bbb"> </span>init-myservice<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">image</span>:<span style="color:#bbb"> </span>busybox<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">command</span>:<span style="color:#bbb"> 
</span><span style="color:#bbb">    </span>- wget<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- <span style="color:#d14">&#34;-O&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>- <span style="color:#d14">&#34;/work-dir/index.html&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>- http://www.baidu.com/index.html<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">volumeMounts</span>:<span style="color:#bbb">
</span><span style="color:#bbb">    </span>- <span style="color:#000080">name</span>:<span style="color:#bbb"> </span>workdir<span style="color:#bbb">
</span><span style="color:#bbb">      </span><span style="color:#000080">mountPath</span>:<span style="color:#bbb"> </span><span style="color:#d14">&#34;/work-dir&#34;</span><span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">volumes</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#000080">name</span>:<span style="color:#bbb"> </span>workdir<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">emptyDir</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span><span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>
<h4 id="静态pod">静态pod</h4>
<ul>
<li>
<p>静态pod特点：</p>
<ul>
<li>pod由特定节点上的kubelet管理</li>
<li>不能使用控制器</li>
<li>pod名称标识当前节点名称</li>
</ul>
</li>
<li>
<p>在kubelet配置文件启用静态pod:
vim /var/lib/kubelet/config.yaml</p>
<pre><code>staticPodPath: /etc/kubernetes/manifests
</code></pre><p>将部署的pod yaml放到该目录会由kubelet自动创建</p>
<p>[root@node02 ~]# cat  /etc/kubernetes/manifests/pod.yaml</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#000080">apiVersion</span>:<span style="color:#bbb"> </span>v1<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000080">kind</span>:<span style="color:#bbb"> </span>Pod<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000080">metadata</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">name</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000080">spec</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">containers</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span>- <span style="color:#000080">name</span>:<span style="color:#bbb"> </span>web<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000080">image</span>:<span style="color:#bbb"> </span>nginx<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><p>在node02 /etc/kubernetes/manifests目录下创建一个yaml，再次查看pod 将会在node2（指定节点）上创建了一个pod,当移走这个文件时pod对应也会销毁</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#000;font-weight:bold">[</span>root@node01 demo<span style="color:#000;font-weight:bold">]</span><span style="color:#998;font-style:italic">#  kubectl get pods</span>
NAME                               READY   STATUS    RESTARTS   AGE
aliang-666-74689c47f4-9xn25        1/1     Running   <span style="color:#099">0</span>          14h
init-demo                          1/1     Running   <span style="color:#099">0</span>          32m
mypod-test                         2/2     Running   <span style="color:#099">0</span>          5h24m
nginx-deployment-c65c76674-kbkpz   1/1     Running   <span style="color:#099">0</span>          4h27m
nginx-deployment-c65c76674-l7z5g   1/1     Running   <span style="color:#099">0</span>          4h27m
nginx-deployment-c65c76674-ljd9k   1/1     Running   <span style="color:#099">0</span>          4h27m
nginx-node02                       1/1     Running   <span style="color:#099">0</span>          13s
web-58d85586c9-ztjdr               1/1     Running   <span style="color:#099">0</span>          4h56m
web2                               1/1     Running   <span style="color:#099">0</span>          10h
</code></pre></td></tr></table>
</div>
</div></li>
</ul>

        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="https://hardy1970.github.io">IT干饭人</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="https://hardy1970.github.io/post/03-kubernetes-life-cycle/">https://hardy1970.github.io/post/03-kubernetes-life-cycle/</a></li>
        <li><strong>版权声明：</strong>本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/02-kubernates-monitor-logs/">02 Kubernetes 监控与日志(Metrics-server)</a></li>
        
        <li><a href="/post/01-kubernates-install/">01 基于kubeadm进行Kubernetes集群搭建(v1.18.0)</a></li>
        
        <li><a href="/post/00-kubernates-command/">00 Kubernetes概念及常用命令(Kubectl、Flannel、Calico)</a></li>
        
        <li><a href="/post/13-kubernates-%E6%8E%92%E9%94%99/">13 Kubernetes 报错 unexpected error getting claim reference: selfLink was empty, can&#39;t make reference</a></li>
        
        <li><a href="/about/">关于我</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/Kubernetes'>Kubernetes</a></li>
                
                <li><a href='/tags/Deployment'>Deployment</a></li>
                
                <li><a href='/tags/Service'>Service</a></li>
                
                <li><a href='/tags/scale'>scale</a></li>
                
            </ul>
            
        </div>
    </article>
    
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "yourdiscussshortname" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "your github repo"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2021 <a href="https://hardy1970.github.io">dreamLinux博客 By IT干饭人</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="http://hardy1970.github.io/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">IT干饭人</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




    <script src='/js/douban.js'></script>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://hardy1970.github.io/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://hardy1970.github.io">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://hardy1970.github.io/post/12-kubernates-monitor-logs/" title="12 Kubernetes 监控方案--cAdvisor&#43;Heapster&#43;Heapster&#43;Grafana">12 Kubernetes 监控方案--cAdvisor&#43;Heapster&#43;Heapster&#43;Grafana</a>
    </li>
    
    <li>
        <a href="https://hardy1970.github.io/post/11-kubernetes-helm/" title="11 kubernetes应用包管理工具(Helm)">11 kubernetes应用包管理工具(Helm)</a>
    </li>
    
    <li>
        <a href="https://hardy1970.github.io/post/10-deploy-demo-on-k8s/" title="10 在k8s平台部署一个网站">10 在k8s平台部署一个网站</a>
    </li>
    
    <li>
        <a href="https://hardy1970.github.io/post/09-kubernetes-kubeadminUpgrage/" title="09 Kubernetes 集群升级与维护">09 Kubernetes 集群升级与维护</a>
    </li>
    
    <li>
        <a href="https://hardy1970.github.io/post/08-kubernetes-etcd/" title="08 Kubernetes ETCD数据备份与恢复">08 Kubernetes ETCD数据备份与恢复</a>
    </li>
    
    <li>
        <a href="https://hardy1970.github.io/post/07-kubernetes-security/" title="07 Kubernetes 安全(RBAC、Authentication、Authorization、Adminssion Control)">07 Kubernetes 安全(RBAC、Authentication、Authorization、Adminssion Control)</a>
    </li>
    
    <li>
        <a href="https://hardy1970.github.io/post/06-kubernetes-storage/" title="06 Kubernetes 存储(本地卷、网络卷、StatefulSet、PV、PVC、ConfigMap、Secret)">06 Kubernetes 存储(本地卷、网络卷、StatefulSet、PV、PVC、ConfigMap、Secret)</a>
    </li>
    
    <li>
        <a href="https://hardy1970.github.io/post/05-kubernetes-network/" title="05 Kubernetes 网络(IPVS、Service、Ingress、IngressController )">05 Kubernetes 网络(IPVS、Service、Ingress、IngressController )</a>
    </li>
    
    <li>
        <a href="https://hardy1970.github.io/post/04-kubernates-schedule/" title="04 Kubernetes 资源调度(resources、nodeselector、nodeAffinity、Taints、Tolerations、nodeName、DaemonSet)">04 Kubernetes 资源调度(resources、nodeselector、nodeAffinity、Taints、Tolerations、nodeName、DaemonSet)</a>
    </li>
    
    <li>
        <a href="https://hardy1970.github.io/post/03-kubernetes-life-cycle/" title="03 Kubernetes 应用程序生命周期管理(Yaml、Pod、Service、Scale、Autoscale、HPA、Rollout)">03 Kubernetes 应用程序生命周期管理(Yaml、Pod、Service、Scale、Autoscale、HPA、Rollout)</a>
    </li>
    
</ul>
    </section>

    
<section class="widget">
    <h3 class="widget-title" style="color:red">福利派送</h3>
    <ul class="widget-list">
        
        <li>
            <a href="https://www.aliyun.com/minisite/goods?userCode=jdg9oj97&amp;share_source=copy_link" title="【2019双12】ALL IN CLoud 低至1折" target="_blank" style="color:red">
                
                    <img src="https://img.alicdn.com/tfs/TB1_rYHo7P2gK0jSZPxXXacQpXa-690-388.jpg">
                
            </a>
        </li>
        
        <li>
            <a href="https://cloud.tencent.com/act/cps/redirect?redirect=1048&amp;cps_key=14ff722692ac784fa8c3301c8c28d924&amp;from=console" title="助力产业智慧升级，云服务器首年88元起，更有千元代金券礼包免费领！" target="_blank" style="color:red">
                
                    <img src="https://upload-dianshi-1255598498.file.myqcloud.com/345-7c71532bd4935fbdd9a67c1a71e577b1767b805c.200%E7%89%88%E6%9C%ACB.jpg">
                
            </a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://hardy1970.github.io/categories/Kubernetes/">Kubernetes (14)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://hardy1970.github.io/tags/Adminssion-Control/">Adminssion Control</a>
    
    <a href="https://hardy1970.github.io/tags/Authentication/">Authentication</a>
    
    <a href="https://hardy1970.github.io/tags/Authorization/">Authorization</a>
    
    <a href="https://hardy1970.github.io/tags/Calico/">Calico</a>
    
    <a href="https://hardy1970.github.io/tags/ConfigMap/">ConfigMap</a>
    
    <a href="https://hardy1970.github.io/tags/Deployment/">Deployment</a>
    
    <a href="https://hardy1970.github.io/tags/Flannel/">Flannel</a>
    
    <a href="https://hardy1970.github.io/tags/Grafana/">Grafana</a>
    
    <a href="https://hardy1970.github.io/tags/Heapster/">Heapster</a>
    
    <a href="https://hardy1970.github.io/tags/Ingress/">Ingress</a>
    
    <a href="https://hardy1970.github.io/tags/Kubernetes/">Kubernetes</a>
    
    <a href="https://hardy1970.github.io/tags/Metrics-server/">Metrics-server</a>
    
    <a href="https://hardy1970.github.io/tags/NFS/">NFS</a>
    
    <a href="https://hardy1970.github.io/tags/RBAC/">RBAC</a>
    
    <a href="https://hardy1970.github.io/tags/Role/">Role</a>
    
    <a href="https://hardy1970.github.io/tags/Secret/">Secret</a>
    
    <a href="https://hardy1970.github.io/tags/Service/">Service</a>
    
    <a href="https://hardy1970.github.io/tags/bash-completion/">bash-completion</a>
    
    <a href="https://hardy1970.github.io/tags/cAdvisor/">cAdvisor</a>
    
    <a href="https://hardy1970.github.io/tags/cni/">cni</a>
    
    <a href="https://hardy1970.github.io/tags/emptyDir/">emptyDir</a>
    
    <a href="https://hardy1970.github.io/tags/etcd/">etcd</a>
    
    <a href="https://hardy1970.github.io/tags/hostPath/">hostPath</a>
    
    <a href="https://hardy1970.github.io/tags/kubeadm/">kubeadm</a>
    
    <a href="https://hardy1970.github.io/tags/kubectl/">kubectl</a>
    
    <a href="https://hardy1970.github.io/tags/logs/">logs</a>
    
    <a href="https://hardy1970.github.io/tags/monitor/">monitor</a>
    
    <a href="https://hardy1970.github.io/tags/network/">network</a>
    
    <a href="https://hardy1970.github.io/tags/network-policy/">network policy</a>
    
    <a href="https://hardy1970.github.io/tags/pod/">pod</a>
    
    <a href="https://hardy1970.github.io/tags/pv/">pv</a>
    
    <a href="https://hardy1970.github.io/tags/pvc/">pvc</a>
    
    <a href="https://hardy1970.github.io/tags/scale/">scale</a>
    
    <a href="https://hardy1970.github.io/tags/storage/">storage</a>
    
    <a href="https://hardy1970.github.io/tags/volume/">volume</a>
    
    <a href="https://hardy1970.github.io/tags/%E5%8A%A8%E6%80%81%E4%BE%9B%E7%BB%99/">动态供给</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://hardy1970.github.io/" title="dreamLinux博客">dreamLinux博客</a>
        </li>
        
        <li>
            <a target="_blank" href="http://yuedu.baidu.com/ebook/14a722970740be1e640e9a3e" title="Android Gradle权威指南">Android Gradle权威指南</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://hardy1970.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>